<ul>
    {% for rule in module.children %}
    <!-- <button type="button" data-toggle="collapse" data-target="#rule-{{rule.id}}">{{ rule.explanation }}</button> -->
    <div class="accordion" id="accordion-{{rule.id}}">
      <div class="card">
        <div class="card-header" id="heading-{{rule.id}}">
          <a data-toggle="collapse" data-parent="#accordion-{{rule.id}}" href="#rule-{{rule.id}}" aria-expanded="true" aria-controls="rule-{{rule.id}}">
            {{ rule.description }}
          </a>
        </div>

        <div id="rule-{{rule.id}}" class="collapse" role="tabpanel" aria-labelledby="heading-{{rule.id}}" data-parent="#accordion-{{rule.id}}">
          <div class="card-body">
            <li>
                {% if rule.is_bundled %}
                    Part of bundled policy: {{ rule.bundle.description }}<BR>
                {% endif %}
                {{ rule.name }} <BR>
                <label>Filter Code: </label>
                <textarea id="filter_{{rule.policy_type}}_{{rule.status}}_{{ rule.id }}"></textarea> <BR>
                <label>Init Code: </label>
                <textarea id="init_{{rule.policy_type}}_{{rule.status}}_{{ rule.id }}"></textarea> <BR>
                <label>Notify Code: </label>
                <textarea id="notify_{{rule.policy_type}}_{{rule.status}}_{{ rule.id }}"></textarea> <BR>
                <label>Conditional Code: </label>
                <textarea id="conditional_{{rule.policy_type}}_{{rule.status}}_{{ rule.id }}"></textarea> <BR>
                <label>Action Code: </label>
                <textarea id="action_{{rule.policy_type}}_{{rule.status}}_{{ rule.id }}"></textarea> <BR>
                <label>Failure Code: </label>
                <textarea id="failure_{{rule.policy_type}}_{{rule.status}}_{{ rule.id }}"></textarea> <BR>
            </li>
            <script>
                var codemirror_init_{{rule.id}} = false;
                var codeTypes_{{rule.id}} = {
                    'filter': `{{ rule.filter | safe }}`,
                    'initialize': `{{ rule.initialize | safe }}`,
                    'check': `{{ rule.check | safe }}`,
                    'notify': `{{ rule.notify | safe }}`,
                    'success': `{{ rule.success | safe }}`,
                    'fail': `{{ rule.fail | safe }}`
                };

                $('#accordion-{{rule.id}}').on('shown.bs.collapse', function() {
                    if (!codemirror_init_{{rule.id}}) {
                        for (let type in codeTypes_{{rule.id}}) {
                            let textArea = document.getElementById(type + '_{{rule.policy_type}}_{{rule.status}}_{{ rule.id }}');
                            let editor = CodeMirror.fromTextArea(textArea, {
                              lineNumbers: true,
                              readOnly: "nocursor"
                            });
                            editor.setValue(codeTypes_{{rule.id}}[type]);
                            editor.refresh();
                        }
                        codemirror_init_{{rule.id}} = true;
                    }
                });
            </script>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
</ul>
