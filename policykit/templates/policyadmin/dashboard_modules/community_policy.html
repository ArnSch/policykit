<ul>
    {% for rule in module.children %}
    <!-- <button type="button" data-toggle="collapse" data-target="#rule-{{rule.id}}">{{ rule.explanation }}</button> -->
    <div class="accordion" id="accordion-{{rule.id}}">
      <div class="card">
        <div class="card-header" id="heading-{{rule.id}}">
          <a data-toggle="collapse" data-parent="#accordion-{{rule.id}}" href="#rule-{{rule.id}}" aria-expanded="true" aria-controls="rule-{{rule.id}}">
            {{ rule.explanation }}
          </a>
        </div>

        <div id="rule-{{rule.id}}" class="collapse" role="tabpanel" aria-labelledby="heading-{{rule.id}}" data-parent="#accordion-{{rule.id}}">
          <div class="card-body">
            <li>
                {% if rule.is_bundled %}
                    Part of bundled policy: {{ rule.bundle.explanation }}<BR>
                {% endif %}
                {{ rule.policy_name }} <BR>
                <label>Filter Code: </label>
                <textarea id="filter_{{rule.policy_type}}_{{rule.status}}_{{ rule.id }}"></textarea> <BR>
                <label>Init Code: </label>
                <textarea id="init_{{rule.policy_type}}_{{rule.status}}_{{ rule.id }}"></textarea> <BR>
                <label>Notify Code: </label>
                <textarea id="notify_{{rule.policy_type}}_{{rule.status}}_{{ rule.id }}"></textarea> <BR>
                <label>Conditional Code: </label>
                <textarea id="conditional_{{rule.policy_type}}_{{rule.status}}_{{ rule.id }}"></textarea> <BR>
                <label>Action Code: </label>
                <textarea id="action_{{rule.policy_type}}_{{rule.status}}_{{ rule.id }}"></textarea> <BR>
                <label>Failure Code: </label>
                <textarea id="failure_{{rule.policy_type}}_{{rule.status}}_{{ rule.id }}"></textarea> <BR>
            </li>
            <script>
                let codemirror_init = false;
                let codeTypes = {
                    'filter': `{{ rule.policy_filter_code | safe }}`,
                    'init': `{{ rule.policy_init_code | safe }}`,
                    'notify': `{{ rule.policy_notify_code | safe }}`,
                    'conditional': `{{ rule.policy_conditional_code | safe }}`,
                    'action': `{{ rule.policy_action_code | safe }}`,
                    'failure': `{{ rule.policy_failure_code | safe }}`
                };

                $('#accordion-{{rule.id}}').on('shown.bs.collapse', function() {
                    if (!codemirror_init) {
                        for (let type in codeTypes) {
                            let textArea = document.getElementById(type + '_{{rule.policy_type}}_{{rule.status}}_{{ rule.id }}');
                            let editor = CodeMirror.fromTextArea(textArea, {
                              lineNumbers: true,
                              readOnly: "nocursor"
                            });
                            editor.setValue(codeTypes[type]);
                            editor.refresh();
                        }
                        codemirror_init = true;
                    }
                });
            </script>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
</ul>
